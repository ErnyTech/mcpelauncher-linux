<!doctype html>
<html>
<head>
    <title>Minecraft Launcher</title>
    <style>
        html, body {
            background: #303030;
            color: #fff;
            font-family: sans-serif;
            text-align: center;
            user-select: none;
            cursor: default;
            margin: 0;
            padding: 0;
        }
        #ctr {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        #action-text {
            padding: 5vh;
        }
        #gamepad-image {
            flex-grow: 1;
            padding: 5vh;
        }
    </style>
</head>
<body>
<div id="ctr">
    <object id="gamepad-image" type="image/svg+xml" data="GamepadXbox.svg"></object>
    <h1 id="action-text">Please wait</h1>
</div>
<script>
    const steps = [
        {
            "text": "Press A",
            "highlight": "button-a",
            "mapping": "button:a"
        },
        {
            "text": "Press B",
            "highlight": "button-b",
            "mapping": "button:b"
        },
        {
            "text": "Press X",
            "highlight": "button-x",
            "mapping": "button:x"
        },
        {
            "text": "Press Y",
            "highlight": "button-y",
            "mapping": "button:y"
        },
        {
            "text": "Press Select",
            "highlight": "button-select",
            "mapping": "button:select"
        },
        {
            "text": "Press Start",
            "highlight": "button-start",
            "mapping": "button:start"
        },
        {
            "text": ["Move left stick to the right", "Move left stick to the left"],
            "highlight": "stick-left",
            "animation": ["move-right 1s infinite", "move-left 1s infinite"],
            "mapping": "axis:leftx"
        },
        {
            "text": ["Move left stick up", "Move left stick down"],
            "highlight": "stick-left",
            "animation": ["move-up 1s infinite", "move-down 1s infinite"],
            "mapping": "axis:lefty"
        },
        {
            "text": ["Move right stick to the right", "Move right stick to the left"],
            "highlight": "stick-right",
            "animation": ["move-right 1s infinite", "move-left 1s infinite"],
            "mapping": "axis:rightx"
        },
        {
            "text": ["Move right stick up", "Move right stick down"],
            "highlight": "stick-right",
            "animation": ["move-up 1s infinite", "move-down 1s infinite"],
            "mapping": "axis:righty"
        },
        {
            "text": "Press the left top shoulder",
            "highlight": "shoulder-left",
            "mapping": "button:lb"
        },
        {
            "text": "Press the left trigger",
            "highlight": "trigger-left",
            "mapping": "axis:trleft"
        },
        {
            "text": "Press the right top shoulder",
            "highlight": "shoulder-right",
            "mapping": "button:rb"
        },
        {
            "text": "Press the right trigger",
            "highlight": "trigger-right",
            "mapping": "axis:trright"
        }
    ];
    let svgDoc;
    let currentStep = -1;
    let currentSubstep = -1;
    let currentMappingType = null;
    let currentMappingId = null;
    let stepButtonPressed = -1;
    let stepStick = -1;
    let stepHat = -1;
    let mapping = {};

    function startStep(stepN, substep) {
        if (currentStep !== -1) {
            let oldEl = svgDoc.getElementById(steps[currentStep].highlight);
            oldEl.classList.remove("active");
            if ("animation" in steps[currentStep])
                oldEl.style.animation = "";
        }
        let stepData = steps[stepN];
        currentStep = stepN;
        currentSubstep = -1;
        stepButtonPressed = -1;
        stepStick = -1;
        stepHat = -1;

        currentMappingId = stepData.mapping;
        currentMappingType = currentMappingId.split(":")[0];

        let el = svgDoc.getElementById(stepData.highlight);
        let textEl = document.getElementById("action-text");
        el.classList.add("active");

        if (stepData.text instanceof Array) {
            if (!substep)
                substep = 0;
            currentSubstep = substep;
            if ("animation" in stepData)
                el.style.animation = stepData.animation[substep];
            textEl.textContent = stepData.text[substep];
        } else {
            if ("animation" in stepData)
                el.style.animation = stepData.animation;
            textEl.textContent = stepData.text;
        }
    }
    function stepFinished() {
        startStep(currentStep + 1);
    }

    window.addEventListener("load", function() {
        svgDoc = document.getElementById("gamepad-image").contentDocument;
        startStep(0);
    });

    gamepadMapper.setGamepadButtonCallback(function(gamepad, btn, pressed) {
        if (pressed && stepButtonPressed === -1) {
            stepButtonPressed = btn;
        } else if (!pressed && btn === stepButtonPressed) {
            if (currentMappingType === "button") {
                mapping[currentMappingId] = {"type": "button", "id": btn};
                stepFinished();
            } else if (currentMappingType === "axis") {
                if (currentSubstep === 0) {
                    mapping[currentMappingId] = {"type": "button", "left-id": btn};
                    startStep(currentStep, 1);
                } else {
                    mapping[currentMappingId]["right-id"] = btn;
                    stepFinished();
                }
            }
        }
    });
    gamepadMapper.setGamepadStickCallback(function(gamepad, stick, value) {
        if (Math.abs(value) > 0.9) {
            stepStick = stick;
        }
        if (Math.abs(value) < 0.2 && stick === stepStick) {
            if (currentMappingType === "button") {
                mapping[currentMappingId] = {"type": "stick", "id": stick, "value": (value > 0 ? 1 : -1)};
                stepFinished();
            } else if (currentMappingType === "axis") {
                mapping[currentMappingId] = {"type": "stick", "id": stick, "value": (value > 0 ? 1 : -1)};
                stepFinished();
            }
        }
    });
    gamepadMapper.setGamepadHatCallback(function(gamepad, hat, value) {
    });
</script>
</body>
</html>